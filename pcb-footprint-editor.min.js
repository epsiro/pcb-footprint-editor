function ElementLine(a,b,c,d,e){this.x1=a,this.y1=b,this.x2=c,this.y2=d,this.thickness=e,this.line=paper.line(0,0,0,0).attr({stroke:"black",strokeWidth:this.thickness}),this.anchor_c=paper.circle(0,0,anchor_size).addClass("anchor_c"),this.anchor_e1=paper.circle(0,0,anchor_size).addClass("anchor_e1"),this.anchor_e2=paper.circle(0,0,anchor_size).addClass("anchor_e2"),this.anchors=paper.group(this.anchor_c,this.anchor_e1,this.anchor_e2).attr({fill:"red",stroke:"#445",strokeWidth:2,visibility:"hidden"}),this.update_anchors(),this.elementline_group=paper.group(this.line,this.anchors),this.elementline_group.attr({"class":"elementline"}),this.draw()}function add_new_object(a){var b=editor.getLine(a);b.match(/Pad/)&&(values=parse_pad_line(b),pad_instance=new Pad(a,a,mm_to_nm(values.x1),mm_to_nm(values.y1),mm_to_nm(values.x2),mm_to_nm(values.y2),mm_to_nm(values.thickness)),console.log("Pad added: ",pad_instance),pad_instance.draw(),zoom_group.add(pad_instance.pad_group),objects.push(pad_instance))}function remove_object(a){editor.getLine(a);pad_instance=objects[a],console.log("Pad removed: ",pad_instance),pad_instance.pad_group.remove(),objects.splice(a,1)}function Pad(a,b,c,d,e,f,g){this.pad_number=a,this.line_number=b;var h=this;this.x1=c,this.y1=d,this.x2=e,this.y2=f,this.thickness=g;this.get_pad_size();this.anchor_c=paper.circle(0,0,anchor_size).addClass("anchor_c"),this.anchor_n=paper.circle(0,0,anchor_size).addClass("anchor_n"),this.anchor_e=paper.circle(0,0,anchor_size).addClass("anchor_e"),this.anchor_s=paper.circle(0,0,anchor_size).addClass("anchor_s"),this.anchor_w=paper.circle(0,0,anchor_size).addClass("anchor_w"),this.anchor_ne=paper.circle(0,0,anchor_size).addClass("anchor_ne"),this.anchor_nw=paper.circle(0,0,anchor_size).addClass("anchor_nw"),this.anchor_se=paper.circle(0,0,anchor_size).addClass("anchor_se"),this.anchor_sw=paper.circle(0,0,anchor_size).addClass("anchor_sw"),this.anchors=paper.group(this.anchor_c,this.anchor_n,this.anchor_e,this.anchor_s,this.anchor_w,this.anchor_ne,this.anchor_nw,this.anchor_se,this.anchor_sw).attr({fill:"white",stroke:"#445",strokeWidth:2,visibility:"hidden"}),this.update_anchors(),this.pad=paper.line(nm_to_view(this.x1),nm_to_view(this.y1),nm_to_view(this.x2),nm_to_view(this.y2)).attr({stroke:"#8c96a0",strokeWidth:nm_to_view(this.thickness),strokeLinecap:"square"}),this.pad_line_ref=paper.line(0,0,0,0).attr({stroke:"red",strokeWidth:2});var i=function(){h.get_pad_size();"true"!=this.attr("endpoint")&&1!=h.endpoint?1!=global_first_endpoint?(h.endpoint=!0,h.endpoint_nr=1,h.endpoint_anchor=this,global_first_endpoint=!0,global_first_endpoint_object=h,this.attr({visibility:"visible",endpoint:"true",stroke:"red"}),h.update_distance_marker()):1!=global_second_endpoint&&(h.endpoint=!0,h.endpoint_nr=2,h.endpoint_anchor=this,global_second_endpoint=!0,global_second_endpoint_object=h,this.attr({visibility:"visible",endpoint:"true",stroke:"blue"}),h.update_distance_marker()):"true"==this.attr("endpoint")&&(1==h.endpoint_nr&&(h.endpoint_nr=0,global_first_endpoint=!1,global_first_endpoint_object=null),2==h.endpoint_nr&&(h.endpoint_nr=0,global_second_endpoint=!1,global_second_endpoint_object=null),h.endpoint_anchor=null,h.endpoint=!1,this.attr({visibility:"",endpoint:"false",stroke:"#445"})),1==global_first_endpoint&&1==global_second_endpoint?(distance_x.attr({visibility:"visible"}),distance_y.attr({visibility:"visible"})):(distance_x.attr({visibility:"hidden"}),distance_y.attr({visibility:"hidden"}))},j=function(){this.pad_size_original=h.get_pad_size(),global_dragging=!0,m()},k=function(a,b){var c=10;switch(this.node.classList[0]){case"anchor_n":var d={x:this.pad_size_original.x,y:this.pad_size_original.y,width:this.pad_size_original.width,height:this.pad_size_original.height-Snap.snapTo(c,b/zoom_level,30)};break;case"anchor_e":var d={x:this.pad_size_original.x,y:this.pad_size_original.y,width:this.pad_size_original.width+Snap.snapTo(c,a/zoom_level,30),height:this.pad_size_original.height};break;case"anchor_s":var d={x:this.pad_size_original.x,y:this.pad_size_original.y-Snap.snapTo(c,b/zoom_level,30),width:this.pad_size_original.width,height:this.pad_size_original.height+Snap.snapTo(c,b/zoom_level,30)};break;case"anchor_w":var d={x:this.pad_size_original.x+Snap.snapTo(c,a/zoom_level,30),y:this.pad_size_original.y,width:this.pad_size_original.width-Snap.snapTo(c,a/zoom_level,30),height:this.pad_size_original.height};break;case"anchor_sw":var d={x:this.pad_size_original.x+Snap.snapTo(c,a/zoom_level,30),y:this.pad_size_original.y-Snap.snapTo(c,b/zoom_level,30),width:this.pad_size_original.width-Snap.snapTo(c,a/zoom_level,30),height:this.pad_size_original.height+Snap.snapTo(c,b/zoom_level,30)};break;case"anchor_se":var d={x:this.pad_size_original.x,y:this.pad_size_original.y-Snap.snapTo(c,b/zoom_level,30),width:this.pad_size_original.width+Snap.snapTo(c,a/zoom_level,30),height:this.pad_size_original.height+Snap.snapTo(c,b/zoom_level,30)};break;case"anchor_ne":var d={x:this.pad_size_original.x,y:this.pad_size_original.y,width:this.pad_size_original.width+Snap.snapTo(c,a/zoom_level,30),height:this.pad_size_original.height-Snap.snapTo(c,b/zoom_level,30)};break;case"anchor_nw":var d={x:this.pad_size_original.x+Snap.snapTo(c,a/zoom_level,30),y:this.pad_size_original.y,width:this.pad_size_original.width-Snap.snapTo(c,a/zoom_level,30),height:this.pad_size_original.height-Snap.snapTo(c,b/zoom_level,30)};break;default:var d={x:this.pad_size_original.x+Snap.snapTo(c,a/zoom_level,30),y:this.pad_size_original.y-Snap.snapTo(c,b/zoom_level,30),width:this.pad_size_original.width,height:this.pad_size_original.height}}h.set_pad_size(d),h.update_editor()},l=function(){global_dragging=!1},m=function(){h.pad.attr({stroke:"#acb6c0"}),h.anchors.attr({visibility:"visible"}),editor.addLineClass(h.line_number,"background","selected_pad")},n=function(){1!=global_dragging&&(h.pad.attr({stroke:"#8c96a0"}),h.anchors.attr({visibility:"hidden"}),editor.removeLineClass(h.line_number,"background","selected_pad"))};this.anchor_c.drag(k,j,l),this.anchor_n.drag(k,j,l),this.anchor_e.drag(k,j,l),this.anchor_s.drag(k,j,l),this.anchor_w.drag(k,j,l),this.anchor_ne.drag(k,j,l),this.anchor_nw.drag(k,j,l),this.anchor_se.drag(k,j,l),this.anchor_sw.drag(k,j,l),this.pad.drag(k,j,l),this.anchor_c.click(i),this.anchor_n.click(i),this.anchor_e.click(i),this.anchor_s.click(i),this.anchor_w.click(i),this.anchor_ne.click(i),this.anchor_nw.click(i),this.anchor_se.click(i),this.anchor_sw.click(i),this.pad_group=paper.group(this.pad,this.pad_line_ref,this.anchors),this.pad_group.hover(m,n),this.pad_group.attr({"class":"pad"})}function parse_pad_line(a){if(!a.match(/Pad/))throw new UserException("InvalidFormat");pad_line=a.substring(a.indexOf("[")+1).match(/\S+/g);var b=pad_line[0].slice(0,-2),c=pad_line[1].slice(0,-2),d=pad_line[2].slice(0,-2),e=pad_line[3].slice(0,-2),f=pad_line[4].slice(0,-2);return{x1:b,y1:c,x2:d,y2:e,thickness:f}}function save_text_as_file(){var a=editor.getValue(),b=new Blob([a],{type:"text/plain"}),c="component.fp",d=document.createElement("a");d.download=c,d.innerHTML="Download File",null!=window.webkitURL?d.href=window.webkitURL.createObjectURL(b):(d.href=window.URL.createObjectURL(b),d.onclick=destroy_clicked_element,d.style.display="none",document.body.appendChild(d)),d.click()}function destroy_clicked_element(a){document.body.removeChild(a.target)}function load_file_as_text(){var a=document.getElementById("file_to_load").files[0],b=new FileReader;b.onload=function(a){editor.setValue(a.target.result)},b.readAsText(a,"UTF-8")}function get_last_line(){var a;return editor.eachLine(function(b){")"===b.text&&(a=editor.getLineNumber(b))}),a}function nm_to_view(a){return 1e8*a}function view_to_nm(a){return a/1e8}function nm_to_mm(a){return 1e6*a}function mm_to_nm(a){return a/1e6}function mouse_wheel_handler(a){a.preventDefault(),a.wheelDelta>0?3>zoom_level&&(zoom_level+=.25):zoom_level>.25&&(zoom_level-=.25),zoom_group.transform("translate("+origin_x+","+origin_y+") scale("+zoom_level+","+-zoom_level+")")}ElementLine.prototype.update_anchors=function(){this.anchor_c.attr({cx:nm_to_view((this.x2-this.x1)/2),cy:nm_to_view((this.y2-this.y1)/2)}),this.anchor_e1.attr({cx:nm_to_view(this.x1),cy:nm_to_view(this.y1)}),this.anchor_e2.attr({cx:nm_to_view(this.x2),cy:nm_to_view(this.y2)})},ElementLine.prototype.draw=function(){this.line.attr({x1:nm_to_view(this.x1),y1:nm_to_view(this.y1),x2:nm_to_view(this.x2),y2:nm_to_view(this.y2)})};var origin_x=300,origin_y=300,global_dragging=!1,global_first_endpoint=!1,global_second_endpoint=!1,global_first_endpoint_object=null,global_second_endpoint_object=null,anchor_size=5,paper=Snap("#svg"),grid_pattern_small=paper.path("M 10 0 L 0 0 0 10").attr({fill:"none",stroke:"gray",strokeWidth:.5}).pattern(0,0,10,10),grid_pattern_big=paper.path("M 100 0 L 0 0 0 100").attr({fill:"none",stroke:"gray",strokeWidth:1}).pattern(0,0,100,100),bg=paper.rect(-1500,-1500,3e3,3e3,0,0).attr({fill:"#fefefe"}),grid_small=paper.rect(-1500,-1500,3e3,3e3,0,0).attr({fill:grid_pattern_small}),grid_big=paper.rect(-1500,-1500,3e3,3e3,0,0).attr({fill:grid_pattern_big}),arrow_start=paper.path("M0,3 L-10,0 L0,-3").attr({stroke:"#aaa",fill:"none"}),arrow_end=paper.path("M0,3 L10,0 L0,-3").attr({stroke:"#aaa",fill:"none"}),marker_start=arrow_start.marker(-10,-6,20,12,-10,0),marker_end=arrow_end.marker(-10,-6,20,12,10,0),distance_x_line=paper.line(0,0,0,0).attr({stroke:"#aaa",strokeWidth:2,markerStart:marker_start,markerEnd:marker_end}),distance_x_text=paper.text(0,0,""),distance_x=paper.group(distance_x_line,distance_x_text);distance_x_text.transform("scale(1,-1)"),distance_x.attr({visibility:"hidden"});var distance_y_line=paper.line(0,0,0,0).attr({stroke:"#aaa",strokeWidth:2,markerStart:marker_start,markerEnd:marker_end}),distance_y_text=paper.text(0,0,""),distance_y=paper.group(distance_y_line,distance_y_text);distance_y_text.transform("scale(1,-1)"),distance_y.attr({visibility:"hidden"});var center=paper.circle(0,0,10).attr({fill:"none",stroke:"gray",strokeWidth:2}),objects=new Array;objects.push("placeholder"),objects.push("placeholder"),Pad.prototype.set_pad_size=function(a){a.width<a.height?(this.thickness=view_to_nm(a.width),this.x1=view_to_nm(a.x)+this.thickness/2,this.y1=view_to_nm(a.y)+this.thickness/2,this.x2=this.x1,this.y2=this.y1+view_to_nm(a.height)-this.thickness):(this.thickness=view_to_nm(a.height),this.x1=view_to_nm(a.x)+this.thickness/2,this.y1=view_to_nm(a.y)+this.thickness/2,this.x2=this.x1+view_to_nm(a.width)-this.thickness,this.y2=this.y1)},Pad.prototype.get_pad_size=function(){var a=this.x1,b=this.y1,c=this.x2,d=this.y2,e=this.thickness;if(a==c)var f=d-b,g=a-e/2,h=b-e/2,i=e,j=f+e;else{if(b!=d)return null;var f=c-a,g=a-e/2,h=b-e/2,i=f+e,j=e}return{x:nm_to_view(g),y:nm_to_view(h),width:nm_to_view(i),height:nm_to_view(j)}},Pad.prototype.draw=function(){return pad_size=this.get_pad_size(),null==pad_size?(editor.removeLineClass(this.line_number,"background","selected_pad"),editor.addLineClass(this.line_number,"background","error_pad"),void console.log("Rotated pad is not supported.")):pad_size.height<0||pad_size.width<0?(editor.removeLineClass(this.line_number,"background","selected_pad"),editor.addLineClass(this.line_number,"background","error_pad"),void console.log("Not valid pad.")):(editor.removeLineClass(this.line_number,"background","error_pad"),this.pad.attr({x1:nm_to_view(this.x1),y1:nm_to_view(this.y1),x2:nm_to_view(this.x2),y2:nm_to_view(this.y2),strokeWidth:nm_to_view(this.thickness)}),this.pad_line_ref.attr({x1:nm_to_view(this.x1)}),this.pad_line_ref.attr({y1:nm_to_view(this.y1)}),this.pad_line_ref.attr({x2:nm_to_view(this.x2)}),this.pad_line_ref.attr({y2:nm_to_view(this.y2)}),this.update_anchors(),this.update_distance_marker(),void console.log("Pad updated with attributes "+this.pad.attr()))},Pad.prototype.update_editor=function(){pad_code=sprintf('    Pad[%.2fmm %.2fmm %.2fmm %.2fmm %.2fmm 0.6mm 1.2mm "" "1" "square"]',nm_to_mm(this.x1),nm_to_mm(this.y1),nm_to_mm(this.x2),nm_to_mm(this.y2),nm_to_mm(this.thickness)),editor.replaceRange(pad_code,{line:this.line_number,ch:0},{line:this.line_number,ch:editor.getLine(this.line_number).length})},Pad.prototype.update_anchors=function(){pad_size=this.get_pad_size(),this.anchor_c.attr({cx:0,cy:0}),this.anchor_n.attr({cx:0,cy:pad_size.height/2}),this.anchor_e.attr({cx:pad_size.width/2,cy:0}),this.anchor_s.attr({cx:0,cy:-pad_size.height/2}),this.anchor_w.attr({cx:-pad_size.width/2,cy:0}),this.anchor_ne.attr({cx:pad_size.width/2,cy:pad_size.height/2}),this.anchor_nw.attr({cx:-pad_size.width/2,cy:pad_size.height/2}),this.anchor_se.attr({cx:pad_size.width/2,cy:-pad_size.height/2}),this.anchor_sw.attr({cx:-pad_size.width/2,cy:-pad_size.height/2}),this.anchors.transform("translate("+(pad_size.x+pad_size.width/2)+","+(pad_size.y+pad_size.height/2)+")")},Pad.prototype.update_distance_marker=function(){if(global_first_endpoint_object==this){var a=this.get_pad_size();distance_x_line.attr({x1:parseInt(this.endpoint_anchor.attr("cx"),10)+a.x+a.width/2,y1:parseInt(this.endpoint_anchor.attr("cy"),10)+a.y+a.height/2,y2:parseInt(this.endpoint_anchor.attr("cy"),10)+a.y+a.height/2}),distance_y_line.attr({y1:parseInt(this.endpoint_anchor.attr("cy"),10)+a.y+a.height/2});var b=Math.round(distance_x_line.attr("x2")-distance_x_line.attr("x1")),c=Math.round(distance_y_line.attr("y2")-distance_y_line.attr("y1"));distance_x_text.attr({x:+distance_x_line.attr("x1")+b/2,y:-distance_x_line.attr("y1")-10,text:b/100+"mm"}),distance_y_text.attr({x:+distance_y_line.attr("x1")+10,y:-distance_y_line.attr("y1")-c/2,text:c/100+"mm"})}if(global_second_endpoint_object==this){var a=this.get_pad_size();distance_x_line.attr({x2:parseInt(this.endpoint_anchor.attr("cx"),10)+a.x+a.width/2}),distance_y_line.attr({x1:parseInt(this.endpoint_anchor.attr("cx"),10)+a.x+a.width/2,x2:parseInt(this.endpoint_anchor.attr("cx"),10)+a.x+a.width/2,y2:parseInt(this.endpoint_anchor.attr("cy"),10)+a.y+a.height/2});var b=Math.round(distance_x_line.attr("x2")-distance_x_line.attr("x1")),c=Math.round(distance_y_line.attr("y2")-distance_y_line.attr("y1"));distance_x_text.attr({x:+distance_x_line.attr("x1")+b/2,y:-distance_x_line.attr("y1")-10,text:b/100+"mm"}),distance_y_text.attr({x:+distance_y_line.attr("x1")+10,y:-distance_y_line.attr("y1")-c/2,text:c/100+"mm"})}};var add_pad=function(a){if("dblclick"==a.type)var b=view_to_nm((a.clientX-origin_x)/zoom_level),c=view_to_nm(-(a.clientY-origin_y)/zoom_level);else var b=0,c=0;var d=b,e=c,f=mm_to_nm(.6);pad_code=sprintf('    Pad[%.2fmm %.2fmm %.2fmm %.2fmm %.2fmm 0.6mm 1.2mm "" "1" "square"]\n',nm_to_mm(b),nm_to_mm(c),nm_to_mm(d),nm_to_mm(e),nm_to_mm(f)),editor.replaceRange(pad_code,{line:get_last_line(),ch:0})};$("#load_file").on("click",load_file_as_text),$("#save_file").on("click",save_text_as_file);var editor=CodeMirror.fromTextArea(document.getElementById("footprint_code"),{lineNumbers:!1,undoDepth:1e4,mode:"text/html",vimMode:!0});editor.on("change",function(a,b){if(""===b.removed[0]){var c=b.to.line;add_new_object(c)}else if(""===b.text[0]){var c=b.from.line;remove_object(c)}else if(b.to.line==b.from.line){var c=b.to.line,d=editor.getLine(b.to.line);d.match(/Pad/)&&(values=parse_pad_line(d),objects.length>=b.to.line+1&&objects[b.to.line].line_number==b.to.line&&(objects[b.to.line].x1=mm_to_nm(values.x1),objects[b.to.line].y1=mm_to_nm(values.y1),objects[b.to.line].x2=mm_to_nm(values.x2),objects[b.to.line].y2=mm_to_nm(values.y2),objects[b.to.line].thickness=mm_to_nm(values.thickness),objects[b.to.line].draw()))}else for(c=b.from.line;c<b.text.length;c++)add_new_object(c)});var hl_line=editor.addLineClass(0,"background","selected_pad");editor.removeLineClass(0,"background","selected_pad"),editor.on("cursorActivity",function(){editor.getLine(editor.getCursor().line).match(/Pad/)&&(editor.removeLineClass(hl_line,"background","selected_pad"),hl_line.text.match(/Pad/)&&objects[editor.getLineNumber(hl_line)].pad.attr({stroke:"#8c96a0"}),hl_line=editor.addLineClass(editor.getCursor().line,"background","selected_pad"),objects[editor.getCursor().line].pad.attr({stroke:"#acb6c0"}))}),editor.on("blur",function(){editor.removeLineClass(hl_line,"background","selected_pad"),hl_line.text.match(/Pad/)&&objects[editor.getLineNumber(hl_line)].pad.attr({stroke:"#8c96a0"})}),$("#vim_mode_cb").click(function(){editor.setOption("vimMode",this.checked)}),$(document).bind("keydown","p",add_pad),$("#svg").dblclick(add_pad);var element_header='Element["" "0805" "0805" "" 1000 1000 -1.5mm -2.5mm 0 100 ""]\n(\n',element_end=")";editor.setValue(element_header+element_end),editor.clearHistory();var begin_drag_workspace=function(){1!=global_dragging&&(this.origin_x=origin_x,this.origin_y=origin_y)},drag_workspace=function(a,b){1!=global_dragging&&(origin_x=this.origin_x+a,origin_y=this.origin_y+b,zoom_group.transform("translate("+origin_x+","+origin_y+") scale("+zoom_level+","+-zoom_level+")"))};paper.node.addEventListener("mousewheel",mouse_wheel_handler,!1),paper.drag(drag_workspace,begin_drag_workspace,null);var zoom_level=1,zoom_group=paper.group(grid_small,grid_big,center,distance_x,distance_y);zoom_group.transform("translate("+origin_x+","+origin_y+") scale("+zoom_level+","+-zoom_level+")");
//# sourceMappingURL=pcb-footprint-editor.min.js.map