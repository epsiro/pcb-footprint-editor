function dblclick_handler(a){file_loaded=!1,"pad"==tool_state?add_pad(a):"elementline"==tool_state?add_elementline(a):"elementarc"==tool_state?add_elementarc(a):"pin"==tool_state&&add_pin(a)}function keyboard_delete_object(){for(var a=0;a<objects.length;a++){var b=objects[a];1==b.selected&&(editor.replaceRange("",{line:b.line_number,ch:0},{line:b.line_number+1,ch:0}),a=0)}}function lock_object(){objects.forEach(function(a){a.selected===!0&&a.lock()})}function unlock_all_objects(){objects.forEach(function(a){"object"==typeof a&&a.unlock()})}function move_selected_objects(a,b){objects.forEach(function(c){c.selected===!0&&c.move(a,b)})}function Refdes(a,b,c,d){this.x=b,this.y=c,this.refdes_text=a;var e=this;this.orig_font_size=mil_to_nm(40),this.text_scale=d,this.refdes=paper.text(0,0,"").attr({"font-size":92}),this.anchor_c=paper.circle(0,0,anchor_size).addClass("anchor_c"),this.anchor_t=paper.circle(0,0,anchor_size).addClass("anchor_t"),this.anchors=paper.group(this.anchor_c,this.anchor_t).attr({fill:"white",stroke:"#445",strokewidth:2});var f=function(){this.original_x=e.x,this.original_y=e.y,this.last_dx=0,this.last_dy=0,global_dragging=!0},g=function(a,b){var c=10;switch(this.node.classList[0]){case"anchor_c":var a=view_to_nm(Snap.snapTo(c,a/zoom_level,30)),b=view_to_nm(Snap.snapTo(c,b/zoom_level,30));e.move(a-this.last_dx,b-this.last_dy),this.last_dx=a,this.last_dy=b;break;case"anchor_t":}e.update_editor()},h=function(){global_dragging=!1};this.anchor_c.drag(g,f,h),this.anchor_t.drag(g,f,h),this.graphical_group=paper.group(this.refdes,this.anchors),this.draw()}function parse_element(a){if(!a.match(/Element\[/))throw new UserException("InvalidFormat");code_line=a.substring(a.indexOf("[")+1).match(/\S+/g);var b=code_line[0].replace(/"/g,""),c=code_line[1].replace(/"/g,""),d=code_line[2].replace(/"/g,""),e=code_line[3].replace(/"/g,""),f=parse_length(code_line[4]),g=parse_length(code_line[5]),h=parse_length(code_line[6]),i=parse_length(code_line[7]),j=code_line[8],k=code_line[9],l=code_line[10].replace(/"/g,"");return{symbolic_flags:b,description:c,name:d,value:e,mark_x:f,mark_y:g,text_pos_x:h,text_pos_y:i,text_direction:j,text_scale:k,text_symbolic_flags:l}}function ElementArc(a,b,c,d,e,f,g){this.line_number=0;var h=this;this.selected=!1,this.locked=!1,this.rx=a,this.ry=b,this.width=c,this.height=d,this.start_angle=e,this.delta_angle=f,this.thickness=g,this.arc=paper.path("").attr({fill:"none",stroke:"black",strokeWidth:nm_to_view(this.thickness),strokeLinecap:"round"}),this.anchor_c=paper.circle(0,0,anchor_size).addClass("anchor_c"),this.anchor_m=paper.circle(0,0,anchor_size).addClass("anchor_m"),this.anchor_s=paper.circle(0,0,anchor_size).addClass("anchor_s"),this.anchor_e=paper.circle(0,0,anchor_size).addClass("anchor_e"),this.anchors=paper.group(this.anchor_c,this.anchor_m,this.anchor_s,this.anchor_e).attr({fill:"white",stroke:"red",strokeWidth:2,visibility:"hidden"}),this.anchor_c.attr({visibility:"visible"}),this.update_anchors();var i=function(){this.original_rx=h.rx,this.original_ry=h.ry,this.original_width=h.width,this.original_height=h.height,this.original_start_angle=h.start_angle,this.original_delta_angle=h.delta_angle,this.original_thickness=h.thickness,this.original_anchor_cx=this.attr("cx"),this.original_anchor_cy=this.attr("cy"),this.last_dx=0,this.last_dy=0,global_dragging=!0,l()},j=function(a,b){var c=10;switch(this.node.classList[0]){case"anchor_c":var a=view_to_nm(Snap.snapTo(c,a/zoom_level,30)),b=view_to_nm(Snap.snapTo(c,b/zoom_level,30));0==h.selected&&h.move(a-this.last_dx,b-this.last_dy),move_selected_objects(a-this.last_dx,b-this.last_dy),this.last_dx=a,this.last_dy=b;break;case"anchor_m":var d=cartesian_to_polar(nm_to_view(this.original_rx),nm_to_view(this.original_ry),+this.original_anchor_cx+a/zoom_level,+this.original_anchor_cy+b/zoom_level);h.width=Math.round(view_to_nm(d.radius)/mm_to_nm(.1))*mm_to_nm(.1),h.height=h.width;break;case"anchor_s":var d=cartesian_to_polar(nm_to_view(this.original_rx),nm_to_view(this.original_ry),+this.original_anchor_cx+a/zoom_level,+this.original_anchor_cy+b/zoom_level);h.start_angle=10*Math.round(d.angle/10);break;case"anchor_e":var d=cartesian_to_polar(nm_to_view(this.original_rx),nm_to_view(this.original_ry),+this.original_anchor_cx+a/zoom_level,+this.original_anchor_cy+b/zoom_level);console.log(d),h.delta_angle=10*Math.round(d.angle/10)-h.start_angle,Math.abs(h.delta_angle)>360&&(h.delta_angle=360*sign(h.delta_angle))}h.update_editor()},k=function(){global_dragging=!1,m()},l=function(){1!=global_dragging&&h.locked===!1&&(h.arc.attr({stroke:"#222"}),h.anchors.attr({visibility:"visible"}),editor.addLineClass(h.line_number,"background","selected_pad"))},m=function(){1!=global_dragging&&(h.arc.attr({stroke:"black"}),h.anchors.attr({visibility:"hidden"}),editor.removeLineClass(h.line_number,"background","selected_pad"))},n=function(a){1==h.selected?(0==a.shiftKey&&deselect_all_objects(),h.unselect()):0==h.selected&&(0==a.shiftKey&&deselect_all_objects(),h.select())};if(this.anchor_c.drag(j,i,k),this.anchor_m.drag(j,i,k),this.anchor_s.drag(j,i,k),this.anchor_e.drag(j,i,k),this.graphical_group=paper.group(this.arc,this.anchors),this.graphical_group.hover(l,m),this.graphical_group.click(n),this.graphical_group.attr({"class":"elementarc"}),1!=file_loaded){l();var o=new Event("mousedown");o.clientX=$("#svg").offset().left+origin_x+nm_to_view(this.rx+this.width)*zoom_level,o.clientY=$("#svg").offset().top+origin_y+nm_to_view(this.ry)*zoom_level,this.anchor_m.node.dispatchEvent(o)}}function parse_elementarc(a){if(!a.match(/ElementArc/))throw new UserException("InvalidFormat");code_line=a.substring(a.indexOf("[")+1).match(/\S+/g);var b=parse_length(code_line[0]),c=parse_length(code_line[1]),d=parse_length(code_line[2]),e=parse_length(code_line[3]),f=code_line[4].trim(),g=code_line[5].trim(),h=parse_length(code_line[6]);return{rx:b,ry:c,width:d,height:e,start_angle:f,delta_angle:g,thickness:h}}function add_elementarc(a){var b=view_to_nm((a.clientX-origin_x-$("#svg").offset().left)/zoom_level),c=view_to_nm((a.clientY-origin_y-$("#svg").offset().top)/zoom_level);b=Math.round(b/mm_to_nm(.1))*mm_to_nm(.1),c=Math.round(c/mm_to_nm(.1))*mm_to_nm(.1);var d=mm_to_nm(0),e=mm_to_nm(0),f=0,g=360,h=mm_to_nm(.2);code=sprintf("    ElementArc[%.2fmm %.2fmm %.2fmm %.2fmm %d %d %.2fmm]\n",nm_to_mm(b),nm_to_mm(c),nm_to_mm(d),nm_to_mm(e),f,g,nm_to_mm(h)),editor.replaceRange(code,{line:get_last_line(),ch:0})}function polar_to_cartesian(a,b,c,d,e){var f=(e-90)*Math.PI/180;return{x:a+c*Math.cos(f),y:b+d*Math.sin(f)}}function cartesian_to_polar(a,b,c,d){var e=c-a,f=d-b;return{radius:Math.sqrt(e*e+f*f),angle:360-(180*Math.atan2(f,e)/Math.PI+180)}}function describe_arc_path(a,b,c,d,e,f){if(360==f){var g=["M",a,b,"m",-c,0,"a",c,d,0,1,1,2*c,0,"a",c,d,0,1,1,-(2*c),0].join(" ");return g}Math.abs(f)>360&&(f=360*sign(f));var h=polar_to_cartesian(a,b,c,d,-e-90),i=polar_to_cartesian(a,b,c,d,-e-f-90),j=f>-180&&180>f?"0":"1",k=0>f?"1":"0",l=["M",h.x,h.y,"A",c,d,0,j,k,i.x,i.y].join(" ");return l}function ElementLine(a,b,c,d,e){this.line_number=0;var f=this;this.selected=!1,this.locked=!1,this.x1=a,this.y1=b,this.x2=c,this.y2=d,this.thickness=e,this.line=paper.line(0,0,0,0).attr({stroke:"black",strokeLinecap:"round"}),this.anchor_c=paper.circle(0,0,anchor_size).addClass("anchor_c"),this.anchor_e1=paper.circle(0,0,anchor_size).addClass("anchor_e1"),this.anchor_e2=paper.circle(0,0,anchor_size).addClass("anchor_e2"),this.anchors=paper.group(this.anchor_c,this.anchor_e1,this.anchor_e2).attr({fill:"white",stroke:"red",strokeWidth:2,visibility:"hidden"}),this.update_anchors();var g=function(){this.original_x1=f.x1,this.original_y1=f.y1,this.original_x2=f.x2,this.original_y2=f.y2,this.original_thickness=f.thickness,this.last_dx=0,this.last_dy=0,global_dragging=!0,j()},h=function(a,b){var c=10;switch(this.node.classList[0]){case"anchor_c":var a=view_to_nm(Snap.snapTo(c,a/zoom_level,30)),b=view_to_nm(Snap.snapTo(c,b/zoom_level,30));0==f.selected&&f.move(a-this.last_dx,b-this.last_dy),move_selected_objects(a-this.last_dx,b-this.last_dy),this.last_dx=a,this.last_dy=b;break;case"anchor_e1":f.x1=this.original_x1+view_to_nm(Snap.snapTo(c,a/zoom_level,30)),f.y1=this.original_y1+view_to_nm(Snap.snapTo(c,b/zoom_level,30));break;case"anchor_e2":f.x2=this.original_x2+view_to_nm(Snap.snapTo(c,a/zoom_level,30)),f.y2=this.original_y2+view_to_nm(Snap.snapTo(c,b/zoom_level,30))}f.update_editor()},i=function(){global_dragging=!1,k()},j=function(){1!=global_dragging&&f.locked===!1&&(f.line.attr({stroke:"#222"}),f.anchors.attr({visibility:"visible"}),editor.addLineClass(f.line_number,"background","selected_pad"))},k=function(){1!=global_dragging&&(f.line.attr({stroke:"black"}),f.anchors.attr({visibility:"hidden"}),editor.removeLineClass(f.line_number,"background","selected_pad"))},l=function(a){1==f.selected?(0==a.shiftKey&&deselect_all_objects(),f.unselect()):0==f.selected&&(0==a.shiftKey&&deselect_all_objects(),f.select())};if(this.anchor_c.drag(h,g,i),this.anchor_e1.drag(h,g,i),this.anchor_e2.drag(h,g,i),this.graphical_group=paper.group(this.line,this.anchors),this.graphical_group.hover(j,k),this.graphical_group.click(l),this.graphical_group.attr({"class":"elementline"}),1!=file_loaded){j();var m=new Event("mousedown");m.clientX=$("#svg").offset().left+origin_x+nm_to_view(this.x1)*zoom_level,m.clientY=$("#svg").offset().top+origin_y+nm_to_view(this.y1)*zoom_level,this.anchor_e2.node.dispatchEvent(m)}}function parse_elementline(a){if(!a.match(/ElementLine/))throw new UserException("InvalidFormat");code_line=a.substring(a.indexOf("[")+1).match(/\S+/g);var b=parse_length(code_line[0]),c=parse_length(code_line[1]),d=parse_length(code_line[2]),e=parse_length(code_line[3]),f=parse_length(code_line[4]);return{x1:b,y1:c,x2:d,y2:e,thickness:f}}function add_elementline(a){var b=view_to_nm((a.clientX-origin_x-$("#svg").offset().left)/zoom_level),c=view_to_nm((a.clientY-origin_y-$("#svg").offset().top)/zoom_level);b=Math.round(b/mm_to_nm(.1))*mm_to_nm(.1),c=Math.round(c/mm_to_nm(.1))*mm_to_nm(.1);var d=b,e=c,f=mm_to_nm(.2);code=sprintf("    ElementLine[%.2fmm %.2fmm %.2fmm %.2fmm %.2fmm]\n",nm_to_mm(b),nm_to_mm(c),nm_to_mm(d),nm_to_mm(e),nm_to_mm(f)),editor.replaceRange(code,{line:get_last_line(),ch:0})}function get_url_and_list_folders_from_lib(){var a="https://api.github.com/repos/Lindem-Data-Acquisition-AS/gedalib/git/refs/heads/dev";$.getJSON(a,function(a){$.getJSON(a.object.url,function(a){$.getJSON(a.tree.url,function(a){$.each(a.tree,function(a,b){if("footprints"==b.path){var c=b.url;list_folders_from_lib(c)}})})})})}function list_folders_from_lib(a){1!=hidden?(hidden=!0,$("div#lib").hide(),$("div#lib").css("width","0%"),$("div#graphical_editor").css("width","50%"),$("div#code").css("width","50%")):(hidden=!1,$("div#lib").show(),$("div#lib").css("width","20%"),$("div#graphical_editor").css("width","40%"),$("div#code").css("width","40%")),$.getJSON(a,function(a){var b=[];$.each(a.tree,function(a,c){b.push("<li role='presentation'><i class='fa-li fa fa-folder'></i><a role='menuitem' href='#' class='folder' data-url='"+c.url+"'>"+c.path+"</a></li>")}),$("ul#gedalib").html(b.join(""))})}function list_components_in_folder(){$("ul#gedalib li ul").remove(),$("ul#gedalib li i").attr("class","fa fa-li fa-folder");var a=$(this).data("url"),b=this;$.getJSON(a,function(a){var c=[];$.each(a.tree,function(a,b){c.push("<li><i class='fa-li fa fa-file-code-o'></i><a href='#' class='file' data-url='"+b.url+"'>"+b.path+"</a></li>")}),$("<ul/>",{"class":"components fa-ul",html:c.join("")}).appendTo($(b).parent())}),$(this).parent().find("i").attr("class","fa fa-li fa-folder-open")}function load_component_from_folder(){var a=$(this).data("url");$.getJSON(a,function(a){file_loaded=!0,new_component(),editor.setValue(atob(a.content))})}function add_object(a,b){return a.match(/Element\[/)?(values=parse_element(a),object_instance=new Refdes(values.name,values.text_pos_x,values.text_pos_y,values.text_scale),console.log("Element added in objects[%d]: ",b),object_instance.draw(),zoom_group.add(object_instance.graphical_group),objects.splice(b,0,object_instance),objects.forEach(update_line_number),0):a.match(/Pad/)?(values=parse_pad_line(a),object_instance=new Pad(b,values.x1,values.y1,values.x2,values.y2,values.thickness,values.clearance,values.mask_thickness,values.number),console.log("Pad added in objects[%d]: ",b),object_instance.draw(),zoom_group.add(object_instance.graphical_group),soldermask_group.add(object_instance.mask),copperplanemask_group.add(object_instance.clearance),objects.splice(b,0,object_instance),objects.forEach(update_line_number),0):a.match(/ElementLine/)?(values=parse_elementline(a),object_instance=new ElementLine(values.x1,values.y1,values.x2,values.y2,values.thickness),console.log("ElementLine added in objects[%d]: ",b),object_instance.draw(),zoom_group.add(object_instance.graphical_group),objects.splice(b,0,object_instance),objects.forEach(update_line_number),0):a.match(/ElementArc/)?(values=parse_elementarc(a),object_instance=new ElementArc(values.rx,values.ry,values.width,values.height,values.start_angle,values.delta_angle,values.thickness),console.log("ElementArc added in objects[%d]: ",b),object_instance.draw(),zoom_group.add(object_instance.graphical_group),objects.splice(b,0,object_instance),objects.forEach(update_line_number),0):a.match(/Pin/)?(values=parse_pin(a),object_instance=new Pin(values.cx,values.cy,values.pad_diameter,values.clearance,values.mask_diameter,values.hole_diameter,values.number),console.log("Pin added in objects[%d]: ",b),object_instance.draw(),zoom_group.add(object_instance.graphical_group),soldermask_group.add(object_instance.mask),copperplanemask_group.add(object_instance.clearance),objects.splice(b,0,object_instance),objects.forEach(update_line_number),0):1}function remove_object(a){return object_instance=objects[a],"placeholder"===object_instance?1:void 0===object_instance?1:(object_instance.graphical_group.remove(),void 0!=object_instance.mask&&object_instance.mask.remove(),void 0!=object_instance.clearance&&object_instance.clearance.remove(),objects.splice(a,1),console.log("Object removed: ",object_instance),objects.forEach(update_line_number),0)}function edit_object(a,b){return a.match(/Element\[/)&&(values=parse_element(a),objects[b].x=values.text_pos_x,objects[b].y=values.text_pos_y,objects[b].refdes_text=values.name,objects[b].text_scale=values.text_scale,objects[b].draw()),a.match(/Pad/)?(values=parse_pad_line(a),objects[b].x1=values.x1,objects[b].y1=values.y1,objects[b].x2=values.x2,objects[b].y2=values.y2,objects[b].thickness=values.thickness,objects[b].mask_margin=values.mask_thickness-values.thickness,objects[b].clearance_margin=values.clearance,objects[b].number=values.number,objects[b].draw(),0):a.match(/ElementLine/)?(values=parse_elementline(a),objects[b].x1=values.x1,objects[b].y1=values.y1,objects[b].x2=values.x2,objects[b].y2=values.y2,objects[b].thickness=values.thickness,objects[b].draw(),0):a.match(/ElementArc/)?(values=parse_elementarc(a),objects[b].rx=values.rx,objects[b].ry=values.ry,objects[b].width=values.width,objects[b].height=values.height,objects[b].start_angle=values.start_angle,objects[b].delta_angle=values.delta_angle,objects[b].thickness=values.thickness,objects[b].draw(),0):a.match(/Pin/)?(values=parse_pin(a),objects[b].cx=values.cx,objects[b].cy=values.cy,objects[b].pad_diameter=values.pad_diameter,objects[b].clearance_margin=values.clearance,objects[b].mask_margin=values.mask_diameter-values.pad_diameter,objects[b].hole_diameter=values.hole_diameter,objects[b].number=values.number,objects[b].draw(),0):1}function update_line_number(a){a.line_number=objects.indexOf(a)}function Pad(a,b,c,d,e,f,g,h,i){this.number=i,this.line_number=a;var j=this;this.selected=!1,this.locked=!1,this.x1=b,this.y1=c,this.x2=d,this.y2=e,this.thickness=f,this.mask_margin=h-f,this.clearance_margin=g;this.get_pad_size();this.anchor_c=paper.circle(0,0,anchor_size).addClass("anchor_c"),this.anchor_n=paper.circle(0,0,anchor_size).addClass("anchor_n"),this.anchor_e=paper.circle(0,0,anchor_size).addClass("anchor_e"),this.anchor_s=paper.circle(0,0,anchor_size).addClass("anchor_s"),this.anchor_w=paper.circle(0,0,anchor_size).addClass("anchor_w"),this.anchor_ne=paper.circle(0,0,anchor_size).addClass("anchor_ne"),this.anchor_nw=paper.circle(0,0,anchor_size).addClass("anchor_nw"),this.anchor_se=paper.circle(0,0,anchor_size).addClass("anchor_se"),this.anchor_sw=paper.circle(0,0,anchor_size).addClass("anchor_sw"),this.anchors=paper.group(this.anchor_c,this.anchor_n,this.anchor_e,this.anchor_s,this.anchor_w,this.anchor_ne,this.anchor_nw,this.anchor_se,this.anchor_sw).attr({fill:"white",stroke:"#445",strokeWidth:2,visibility:"hidden"}),this.update_anchors(),this.pad=paper.line(0,0,0,0).attr({stroke:"#8c96a0",strokeWidth:0,strokeLinecap:"square"}),this.mask=paper.line(0,0,0,0).attr({stroke:"black",strokeWidth:0,strokeLinecap:"square"}),this.clearance=paper.line(0,0,0,0).attr({stroke:"black",strokeWidth:0,strokeLinecap:"square"}),this.pad_line_ref=paper.line(0,0,0,0).attr({stroke:"red",strokeWidth:2,visibility:"hidden"}),this.show_number=paper.text(0,0,"").attr({"font-size":42,fill:"red",textAnchor:"middle","alignment-baseline":"central",visibility:"visible"});var k=function(){j.get_pad_size();"true"!=this.attr("endpoint")&&1!=j.endpoint?1!=global_first_endpoint?(j.endpoint=!0,j.endpoint_nr=1,j.endpoint_anchor=this,global_first_endpoint=!0,global_first_endpoint_object=j,this.attr({visibility:"visible",endpoint:"true",stroke:"red"}),j.update_distance_marker()):1!=global_second_endpoint&&(j.endpoint=!0,j.endpoint_nr=2,j.endpoint_anchor=this,global_second_endpoint=!0,global_second_endpoint_object=j,this.attr({visibility:"visible",endpoint:"true",stroke:"blue"}),j.update_distance_marker()):"true"==this.attr("endpoint")&&(1==j.endpoint_nr&&(j.endpoint_nr=0,global_first_endpoint=!1,global_first_endpoint_object=null),2==j.endpoint_nr&&(j.endpoint_nr=0,global_second_endpoint=!1,global_second_endpoint_object=null),j.endpoint_anchor=null,j.endpoint=!1,this.attr({visibility:"",endpoint:"false",stroke:"#445"})),1==global_first_endpoint&&1==global_second_endpoint?(distance_x.attr({visibility:"visible"}),distance_y.attr({visibility:"visible"}),$("#status_xy_distance").show()):(distance_x.attr({visibility:"hidden"}),distance_y.attr({visibility:"hidden"}),$("#status_xy_distance").hide())},l=function(){this.pad_size_original=j.get_pad_size(),this.last_dx=0,this.last_dy=0,global_dragging=!0,o()},m=function(a,b){var c=10;switch(this.node.classList[0]){case"anchor_s":var d={x:this.pad_size_original.x,y:this.pad_size_original.y,width:this.pad_size_original.width,height:this.pad_size_original.height+view_to_nm(Snap.snapTo(c,b/zoom_level,30))};break;case"anchor_e":var d={x:this.pad_size_original.x,y:this.pad_size_original.y,width:this.pad_size_original.width+view_to_nm(Snap.snapTo(c,a/zoom_level,30)),height:this.pad_size_original.height};break;case"anchor_n":var d={x:this.pad_size_original.x,y:this.pad_size_original.y+view_to_nm(Snap.snapTo(c,b/zoom_level,30)),width:this.pad_size_original.width,height:this.pad_size_original.height-view_to_nm(Snap.snapTo(c,b/zoom_level,30))};break;case"anchor_w":var d={x:this.pad_size_original.x+view_to_nm(Snap.snapTo(c,a/zoom_level,30)),y:this.pad_size_original.y,width:this.pad_size_original.width-view_to_nm(Snap.snapTo(c,a/zoom_level,30)),height:this.pad_size_original.height};break;case"anchor_nw":var d={x:this.pad_size_original.x+view_to_nm(Snap.snapTo(c,a/zoom_level,30)),y:this.pad_size_original.y+view_to_nm(Snap.snapTo(c,b/zoom_level,30)),width:this.pad_size_original.width-view_to_nm(Snap.snapTo(c,a/zoom_level,30)),height:this.pad_size_original.height-view_to_nm(Snap.snapTo(c,b/zoom_level,30))};break;case"anchor_ne":var d={x:this.pad_size_original.x,y:this.pad_size_original.y+view_to_nm(Snap.snapTo(c,b/zoom_level,30)),width:this.pad_size_original.width+view_to_nm(Snap.snapTo(c,a/zoom_level,30)),height:this.pad_size_original.height-view_to_nm(Snap.snapTo(c,b/zoom_level,30))};break;case"anchor_se":var d={x:this.pad_size_original.x,y:this.pad_size_original.y,width:this.pad_size_original.width+view_to_nm(Snap.snapTo(c,a/zoom_level,30)),height:this.pad_size_original.height+view_to_nm(Snap.snapTo(c,b/zoom_level,30))};break;case"anchor_sw":var d={x:this.pad_size_original.x+view_to_nm(Snap.snapTo(c,a/zoom_level,30)),y:this.pad_size_original.y,width:this.pad_size_original.width-view_to_nm(Snap.snapTo(c,a/zoom_level,30)),height:this.pad_size_original.height+view_to_nm(Snap.snapTo(c,b/zoom_level,30))};break;case"anchor_c":var d={x:this.pad_size_original.x+view_to_nm(Snap.snapTo(c,a/zoom_level,30)),y:this.pad_size_original.y+view_to_nm(Snap.snapTo(c,b/zoom_level,30)),width:this.pad_size_original.width,height:this.pad_size_original.height},a=view_to_nm(Snap.snapTo(c,a/zoom_level,30)),b=view_to_nm(Snap.snapTo(c,b/zoom_level,30));0==j.selected&&j.move(a-this.last_dx,b-this.last_dy),move_selected_objects(a-this.last_dx,b-this.last_dy),this.last_dx=a,this.last_dy=b}j.set_pad_size(d),j.update_editor()},n=function(){global_dragging=!1},o=function(){1!=global_dragging&&j.locked===!1&&(j.pad.attr({stroke:"#acb6c0"}),j.anchors.attr({visibility:"visible"}),editor.addLineClass(j.line_number,"background","selected_pad"),$("#object_info").show().html(j.get_info()))},p=function(){1!=global_dragging&&(j.pad.attr({stroke:"#8c96a0"}),j.anchors.attr({visibility:"hidden"}),editor.removeLineClass(j.line_number,"background","selected_pad"),$("#object_info").hide())},q=function(a){1==j.selected?(0==a.shiftKey&&deselect_all_objects(),j.unselect()):0==j.selected&&(0==a.shiftKey&&deselect_all_objects(),j.select())};this.anchor_c.drag(m,l,n),this.anchor_n.drag(m,l,n),this.anchor_e.drag(m,l,n),this.anchor_s.drag(m,l,n),this.anchor_w.drag(m,l,n),this.anchor_ne.drag(m,l,n),this.anchor_nw.drag(m,l,n),this.anchor_se.drag(m,l,n),this.anchor_sw.drag(m,l,n),this.anchor_c.click(k),this.anchor_n.click(k),this.anchor_e.click(k),this.anchor_s.click(k),this.anchor_w.click(k),this.anchor_ne.click(k),this.anchor_nw.click(k),this.anchor_se.click(k),this.anchor_sw.click(k),this.graphical_group=paper.group(this.pad,this.clearance,this.mask,this.pad_line_ref,this.show_number,this.anchors),this.graphical_group.hover(o,p),this.graphical_group.click(q),this.graphical_group.attr({"class":"pad"})}function add_pad(a){if("dblclick"==a.type){var b=view_to_nm((a.clientX-origin_x-$("#svg").offset().left)/zoom_level),c=view_to_nm((a.clientY-origin_y-$("#svg").offset().top)/zoom_level);b=Math.round(b/mm_to_nm(.1))*mm_to_nm(.1),c=Math.round(c/mm_to_nm(.1))*mm_to_nm(.1)}else var b=0,c=0;var d=b,e=c,f=mm_to_nm(.6),g=mm_to_nm(.8),h=mm_to_nm(1),i=1;pad_code=sprintf('    Pad[%.2fmm %.2fmm %.2fmm %.2fmm %.2fmm %.2fmm %.2fmm "" "%d" "square"]\n',nm_to_mm(b),nm_to_mm(c),nm_to_mm(d),nm_to_mm(e),nm_to_mm(f),nm_to_mm(h),nm_to_mm(g),i),editor.replaceRange(pad_code,{line:get_last_line(),ch:0})}function parse_pad_line(a){if(!a.match(/Pad/))throw new UserException("InvalidFormat");code_line=a.substring(a.indexOf("[")+1).match(/\S+/g);var b=parse_length(code_line[0]),c=parse_length(code_line[1]),d=parse_length(code_line[2]),e=parse_length(code_line[3]),f=parse_length(code_line[4]),g=parse_length(code_line[5]),h=parse_length(code_line[6]),i=code_line[7].replace(/"/g,""),j=code_line[8].replace(/"/g,""),k=code_line[9].replace(/"/g,"");return{x1:b,y1:c,x2:d,y2:e,thickness:f,clearance:g,mask_thickness:h,name:i,number:j,symbolic_flags:k}}function Pin(a,b,c,d,e,f,g){this.line_number=0,this.number=g;var h=this;this.selected=!1,this.locked=!1,this.cx=a,this.cy=b,this.hole_diameter=f,this.pad_diameter=c,this.mask_margin=e-c,this.clearance_margin=d,this.pad=paper.circle(0,0,0).attr({fill:"#8c96a0"}),this.mask=paper.circle(0,0,0).attr({stroke:"none",fill:"black"}),this.clearance=paper.circle(0,0,0).attr({stroke:"none",fill:"black"}),this.hole=paper.circle(0,0,0).attr({fill:"white"}),this.show_number=paper.text(0,0,"").attr({"font-size":42,fill:"red",textAnchor:"middle","alignment-baseline":"central",visibility:"visible"}),console.log(this),this.anchor_c=paper.circle(0,0,anchor_size).addClass("anchor_c"),this.anchor_h=paper.circle(0,0,anchor_size).addClass("anchor_h"),this.anchor_p=paper.circle(0,0,anchor_size).addClass("anchor_p"),console.log(this),this.anchors=paper.group(this.anchor_c,this.anchor_h,this.anchor_p).attr({fill:"white",stroke:"#445",strokewidth:2,visibility:"hidden"}),this.update_anchors();var i=function(){this.original_cx=h.cx,this.original_cy=h.cy,this.original_hole_diameter=h.hole_diameter,this.original_pad_diameter=h.pad_diameter,this.last_dx=0,this.last_dy=0,global_dragging=!0,l()},j=function(a,b){var c=10;switch(this.node.classList[0]){case"anchor_c":var a=view_to_nm(Snap.snapTo(c,a/zoom_level,30)),b=view_to_nm(Snap.snapTo(c,b/zoom_level,30));0==h.selected&&h.move(a-this.last_dx,b-this.last_dy),move_selected_objects(a-this.last_dx,b-this.last_dy),this.last_dx=a,this.last_dy=b;break;case"anchor_h":var d=this.original_hole_diameter+view_to_nm(2*Snap.snapTo(c,a/zoom_level,30));d>0&&d<h.pad_diameter&&(h.hole_diameter=d);break;case"anchor_p":var e=this.original_pad_diameter+view_to_nm(2*Snap.snapTo(c,a/zoom_level,30));e>0&&e>h.hole_diameter&&(h.pad_diameter=e)}h.update_editor()},k=function(){global_dragging=!1,m()},l=function(){1!=global_dragging&&h.locked===!1&&(h.pad.attr({fill:"#acb6c0"}),h.anchors.attr({visibility:"visible"}),editor.addLineClass(h.line_number,"background","selected_pad")),$("#object_info").show().html(h.get_info())},m=function(){1!=global_dragging&&(h.pad.attr({fill:"#8c96a0"}),h.anchors.attr({visibility:"hidden"}),editor.removeLineClass(h.line_number,"background","selected_pad")),$("#object_info").hide()},n=function(a){1==h.selected?(0==a.shiftKey&&deselect_all_objects(),h.unselect()):0==h.selected&&(0==a.shiftKey&&deselect_all_objects(),h.select())};this.anchor_c.drag(j,i,k),this.anchor_h.drag(j,i,k),this.anchor_p.drag(j,i,k),this.graphical_group=paper.group(this.pad,this.clearance,this.mask,this.hole,this.show_number,this.anchors),this.graphical_group.hover(l,m),this.graphical_group.click(n),this.graphical_group.attr({"class":"pin"})}function parse_pin(a){if(!a.match(/Pin/))throw new UserException("InvalidFormat");code_line=a.substring(a.indexOf("[")+1).match(/\S+/g);var b=parse_length(code_line[0]),c=parse_length(code_line[1]),d=parse_length(code_line[2]),e=parse_length(code_line[3]),f=parse_length(code_line[4]),g=parse_length(code_line[5]),h=code_line[6].replace(/"/g,""),i=code_line[7].replace(/"/g,""),j=code_line[8].replace(/"/g,"");return{cx:b,cy:c,pad_diameter:d,clearance:e,mask_diameter:f,hole_diameter:g,name:h,number:i,symbolic_flags:j}}function add_pin(a){var b=view_to_nm((a.clientX-origin_x-$("#svg").offset().left)/zoom_level),c=view_to_nm((a.clientY-origin_y-$("#svg").offset().top)/zoom_level);b=Math.round(b/mm_to_nm(.1))*mm_to_nm(.1),c=Math.round(c/mm_to_nm(.1))*mm_to_nm(.1);var d=mm_to_nm(.4),e=mm_to_nm(1),f=mm_to_nm(1),g=mm_to_nm(1.2),h=1;code=sprintf('    Pin[%.2fmm %.2fmm %.2fmm %.2fmm %.2fmm %.2fmm "" "%d" ""]\n',nm_to_mm(b),nm_to_mm(c),nm_to_mm(e),nm_to_mm(f),nm_to_mm(g),nm_to_mm(d),h),editor.replaceRange(code,{line:get_last_line(),ch:0})}function save_text_as_file(){var a=editor.getValue(),b=new Blob([a],{type:"text/plain"}),c="component.fp",d=document.createElement("a");d.download=c,d.innerHTML="Download File",null!=window.webkitURL?d.href=window.webkitURL.createObjectURL(b):(d.href=window.URL.createObjectURL(b),d.onclick=destroy_clicked_element,d.style.display="none",document.body.appendChild(d)),d.click()}function destroy_clicked_element(a){document.body.removeChild(a.target)}function load_file_as_text(){var a=document.getElementById("file_to_load").files[0],b=new FileReader;b.onload=function(a){file_loaded=!0,new_component(),editor.setValue(a.target.result)},b.readAsText(a,"UTF-8")}function get_last_line(){var a;return editor.eachLine(function(b){")"===b.text&&(a=editor.getLineNumber(b))}),a}function new_component(){var a='Element["" "0805" "0805" "" 1000 1000 -1.5mm -2.5mm 0 100 ""]\n(\n',b=")";editor.setValue(a+b),editor.clearHistory(),distance_x.attr({visibility:"hidden"}),distance_y.attr({visibility:"hidden"}),$("#status_xy_distance").hide(),global_dragging=!1,global_first_endpoint=!1,global_second_endpoint=!1,global_first_endpoint_object=null,global_second_endpoint_object=null}function nm_to_view(a){return a/1e4}function view_to_nm(a){return 1e4*a}function nm_to_mm(a){return a/1e6}function mm_to_nm(a){return 1e6*a}function nm_to_mil(a){return a/25400}function mil_to_nm(a){return 25400*a}function nm_to_hundredth_mil(a){return a/254}function hundredth_mil_to_nm(a){return 254*a}function parse_length(a){var b=a.indexOf("mm");if(b>-1)return mm_to_nm(a.slice(0,b).trim());var c=a.indexOf("mil");if(c>-1)return mil_to_nm(a.slice(0,c).trim());var d="square";if($.isNumeric(a)){if("round"==d)return mil_to_nm(a.trim());if("square"==d)return hundredth_mil_to_nm(a.trim())}}function sign(a){return a>0?1:0>a?-1:0}function mouse_wheel_handler(a){a.preventDefault(),a.wheelDelta>0?3>zoom_level&&(zoom_level+=zoom_level>=.25?.25:.05):zoom_level>.25?zoom_level-=.25:zoom_level>.15&&(zoom_level-=.05),.25>zoom_level?(grid_small.attr({fill:grid_pattern_mm}),grid_big.attr({fill:grid_pattern_cm})):.5>zoom_level?(anchor_size=10,grid_small.attr({fill:grid_pattern_mm}),grid_big.attr({fill:grid_pattern_cm})):(anchor_size=5,grid_small.attr({fill:grid_pattern_tenth_mm}),grid_big.attr({fill:grid_pattern_mm})),console.log(zoom_level),zoom_group.transform("translate("+origin_x+","+origin_y+") scale("+zoom_level+","+zoom_level+")")}$(".status_tooltip").tooltip(),$("a").tooltip(),$("button").tooltip(),$("#controls_mode button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),"controls_new_pad"==$(this).attr("id")?tool_state="pad":"controls_new_elementline"==$(this).attr("id")?tool_state="elementline":"controls_new_elementarc"==$(this).attr("id")?tool_state="elementarc":"controls_new_pin"==$(this).attr("id")&&(tool_state="pin")}),$("#controls_soldermask").on("click",function(){$(this).hasClass("active")?($(this).removeClass("active"),solderstop.attr({fill:"none"})):($(this).addClass("active"),solderstop.attr({fill:"green"}))}),$("#controls_copperplane").on("click",function(){$(this).hasClass("active")?($(this).removeClass("active"),copperplane.attr({fill:"none"})):($(this).addClass("active"),copperplane.attr({fill:"#8c96a0"}))}),$("#controls_undo").on("click",function(){editor.undo()}),$("#controls_redo").on("click",function(){editor.redo()}),$("#controls_new_component").on("click",new_component),$("#load_file").on("click",function(){$("#file_to_load").click()}),$("#file_to_load").on("change",load_file_as_text),$("#save_file").on("click",save_text_as_file),$("#status_xy_distance").hide(),$("#controls_load_component_from_lib").on("click",get_url_and_list_folders_from_lib),$("ul#gedalib").on("click","a.folder",list_components_in_folder),$("ul#gedalib").on("click","a.file",load_component_from_folder),file_loaded=!1;var tool_state="pad";$("#controls_lock_object").on("click",lock_object),$("#controls_unlock_all_objects").on("click",unlock_all_objects),$("#controls_delete_object").on("click",keyboard_delete_object),$(document).keydown(function(a){46==a.keyCode&&keyboard_delete_object()}),$(document).bind("keydown","p",add_pad),$("#svg").dblclick(dblclick_handler),Refdes.prototype.draw=function(){if(""==this.refdes_text)var a="X1";else var a=this.refdes_text;this.refdes.attr({x:nm_to_view(this.x),y:nm_to_view(this.y),text:a});var b=this.text_scale/100;this.refdes.transform("translate("+-nm_to_view(this.x)*(b-1)+","+-nm_to_view(this.y)*(b-1)+") scale("+b+")"),this.update_anchors()},Refdes.prototype.update_anchors=function(){this.anchor_c.attr({cx:nm_to_view(this.x),cy:nm_to_view(this.y),r:anchor_size}),this.anchor_t.attr({cx:nm_to_view(this.x),cy:nm_to_view(this.y-.5*this.orig_font_size*this.text_scale/100),r:anchor_size})
},Refdes.prototype.move=function(a,b){this.x=this.x+a,this.y=this.y+b,this.update_editor()},Refdes.prototype.update_editor=function(){code=sprintf('Element["" "" "%s" "" %.2fmm %.2fmm %.2fmm %.2fmm %d %d ""]',this.refdes_text,1,1,nm_to_mm(this.x),nm_to_mm(this.y),0,this.text_scale),editor.replaceRange(code,{line:this.line_number,ch:0},{line:this.line_number,ch:editor.getLine(this.line_number).length})},Refdes.prototype.select=function(){},Refdes.prototype.unselect=function(){},Refdes.prototype.lock=function(){},Refdes.prototype.unlock=function(){},ElementArc.prototype.update_editor=function(){code=sprintf("    ElementArc[%.2fmm %.2fmm %.2fmm %.2fmm %d %d %.2fmm]",nm_to_mm(this.rx),nm_to_mm(this.ry),nm_to_mm(this.width),nm_to_mm(this.height),this.start_angle,this.delta_angle,nm_to_mm(this.thickness)),editor.replaceRange(code,{line:this.line_number,ch:0},{line:this.line_number,ch:editor.getLine(this.line_number).length})},ElementArc.prototype.update_anchors=function(){var a;this.anchor_c.attr({cx:nm_to_view(this.rx),cy:nm_to_view(this.ry)}),a=polar_to_cartesian(nm_to_view(this.rx),nm_to_view(this.ry),nm_to_view(this.width),nm_to_view(this.height),-this.start_angle-90),this.anchor_s.attr({cx:a.x,cy:a.y}),a=polar_to_cartesian(nm_to_view(this.rx),nm_to_view(this.ry),nm_to_view(this.width),nm_to_view(this.height),-this.start_angle-this.delta_angle/2-90),this.anchor_m.attr({cx:a.x,cy:a.y}),a=polar_to_cartesian(nm_to_view(this.rx),nm_to_view(this.ry),nm_to_view(this.width),nm_to_view(this.height),-this.start_angle-this.delta_angle-90),this.anchor_e.attr({cx:a.x,cy:a.y})},ElementArc.prototype.draw=function(){this.arc.attr({d:describe_arc_path(nm_to_view(this.rx),nm_to_view(this.ry),nm_to_view(this.width),nm_to_view(this.height),this.start_angle,this.delta_angle),strokeWidth:nm_to_view(this.thickness)}),this.update_anchors()},ElementArc.prototype.move=function(a,b){this.rx=this.rx+a,this.ry=this.ry+b,this.update_editor()},ElementArc.prototype.select=function(){this.locked===!1&&(this.selected=!0,this.graphical_group.attr({opacity:.7}))},ElementArc.prototype.unselect=function(){this.selected=!1,this.graphical_group.attr({opacity:1})},ElementArc.prototype.lock=function(){this.locked=!0},ElementArc.prototype.unlock=function(){this.locked=!1},ElementLine.prototype.update_editor=function(){code=sprintf("    ElementLine[%.2fmm %.2fmm %.2fmm %.2fmm %.2fmm]",nm_to_mm(this.x1),nm_to_mm(this.y1),nm_to_mm(this.x2),nm_to_mm(this.y2),nm_to_mm(this.thickness)),editor.replaceRange(code,{line:this.line_number,ch:0},{line:this.line_number,ch:editor.getLine(this.line_number).length})},ElementLine.prototype.update_anchors=function(){this.anchor_c.attr({cx:nm_to_view(this.x1+(this.x2-this.x1)/2),cy:nm_to_view(this.y1+(this.y2-this.y1)/2),r:anchor_size}),this.anchor_e1.attr({cx:nm_to_view(this.x1),cy:nm_to_view(this.y1),r:anchor_size}),this.anchor_e2.attr({cx:nm_to_view(this.x2),cy:nm_to_view(this.y2),r:anchor_size})},ElementLine.prototype.draw=function(){this.line.attr({x1:nm_to_view(this.x1),y1:nm_to_view(this.y1),x2:nm_to_view(this.x2),y2:nm_to_view(this.y2),strokeWidth:nm_to_view(this.thickness)}),this.update_anchors()},ElementLine.prototype.move=function(a,b){this.x1=this.x1+a,this.x2=this.x2+a,this.y1=this.y1+b,this.y2=this.y2+b,this.update_editor()},ElementLine.prototype.select=function(){this.locked===!1&&(this.selected=!0,this.graphical_group.attr({opacity:.7}))},ElementLine.prototype.unselect=function(){this.selected=!1,this.graphical_group.attr({opacity:1})},ElementLine.prototype.lock=function(){this.locked=!0},ElementLine.prototype.unlock=function(){this.locked=!1};var origin_x=300,origin_y=300,global_dragging=!1,global_first_endpoint=!1,global_second_endpoint=!1,global_first_endpoint_object=null,global_second_endpoint_object=null,anchor_size=5,paper=Snap("#svg"),grid_pattern_tenth_mm=paper.path("M 10 0 L 0 0 0 10").attr({fill:"none",stroke:"gray",strokeWidth:.5}).pattern(0,0,10,10),grid_pattern_mm=paper.path("M 100 0 L 0 0 0 100").attr({fill:"none",stroke:"gray",strokeWidth:2}).pattern(0,0,100,100),grid_pattern_cm=paper.path("M 1000 0 L 0 0 0 1000").attr({fill:"none",stroke:"gray",strokeWidth:5}).pattern(0,0,1e3,1e3),bg=paper.rect(-15e3,-15e3,3e4,3e4,0,0).attr({fill:"#fefefe"}),grid_small=paper.rect(-15e3,-15e3,3e4,3e4,0,0).attr({fill:grid_pattern_tenth_mm}),grid_big=paper.rect(-15e3,-15e3,3e4,3e4,0,0).attr({fill:grid_pattern_mm}),soldermask_bg=paper.rect(-15e3,-15e3,3e4,3e4).attr({fill:"white"}),soldermask_group=paper.group(soldermask_bg),solderstop=paper.rect(-15e3,-15e3,3e4,3e4,0,0).attr({fill:"none","fill-opacity":.5,mask:soldermask_group}),copperplanemask_bg=paper.rect(-15e3,-15e3,3e4,3e4).attr({fill:"white"}),copperplanemask_group=paper.group(copperplanemask_bg),copperplane=paper.rect(-15e3,-15e3,3e4,3e4,0,0).attr({fill:"none","fill-opacity":.8,mask:copperplanemask_group}),arrow_start=paper.path("M0,3 L-10,0 L0,-3").attr({stroke:"#aaa",fill:"none"}),arrow_end=paper.path("M0,3 L10,0 L0,-3").attr({stroke:"#aaa",fill:"none"}),marker_start=arrow_start.marker(-10,-6,20,12,-10,0),marker_end=arrow_end.marker(-10,-6,20,12,10,0),distance_x_line=paper.line(0,0,0,0).attr({stroke:"#aaa",strokeWidth:2,markerStart:marker_start,markerEnd:marker_end}),distance_x_text=paper.text(0,0,""),distance_x=paper.group(distance_x_line,distance_x_text);distance_x.attr({visibility:"hidden"});var distance_y_line=paper.line(0,0,0,0).attr({stroke:"#aaa",strokeWidth:2,markerStart:marker_start,markerEnd:marker_end}),distance_y_text=paper.text(0,0,""),distance_y=paper.group(distance_y_line,distance_y_text);distance_y.attr({visibility:"hidden"});var center=paper.circle(0,0,10).attr({fill:"none",stroke:"gray",strokeWidth:2}),selection_box=paper.rect(0,0,0,0).attr({stroke:"black",strokeWidth:"1",fill:"none",visibility:"hidden"}),hidden=!0;$("div#lib").hide();var objects=new Array;objects.push("placeholder"),Pad.prototype.set_pad_size=function(a){a.width<a.height?(this.thickness=a.width,this.x1=a.x+this.thickness/2,this.y1=a.y+this.thickness/2,this.x2=this.x1,this.y2=this.y1+a.height-this.thickness):(this.thickness=a.height,this.x1=a.x+this.thickness/2,this.y1=a.y+this.thickness/2,this.x2=this.x1+a.width-this.thickness,this.y2=this.y1)},Pad.prototype.get_pad_size=function(){var a=this.x1,b=this.y1,c=this.x2,d=this.y2,e=this.thickness;if(a==c){var f=Math.abs(d-b),g=a-e/2;if(0>d-b)var h=b-e/2-f;else var h=b-e/2;var i=e,j=f+e}else{if(b!=d)return null;var f=Math.abs(c-a);if(0>c-a)var g=a-e/2-f;else var g=a-e/2;var h=b-e/2,i=f+e,j=e}return{x:g,y:h,width:i,height:j}},Pad.prototype.draw=function(){return pad_size=this.get_pad_size(),null==pad_size?(editor.removeLineClass(this.line_number,"background","selected_pad"),editor.addLineClass(this.line_number,"background","error_pad"),void console.log("Rotated pad is not supported.")):pad_size.height<0||pad_size.width<0?(editor.removeLineClass(this.line_number,"background","selected_pad"),editor.addLineClass(this.line_number,"background","error_pad"),void console.log("Not valid pad.")):(editor.removeLineClass(this.line_number,"background","error_pad"),this.pad.attr({x1:nm_to_view(this.x1),y1:nm_to_view(this.y1),x2:nm_to_view(this.x2),y2:nm_to_view(this.y2),strokeWidth:nm_to_view(this.thickness)}),this.mask.attr({x1:nm_to_view(this.x1),y1:nm_to_view(this.y1),x2:nm_to_view(this.x2),y2:nm_to_view(this.y2),strokeWidth:nm_to_view(this.thickness+this.mask_margin)}),this.clearance.attr({x1:nm_to_view(this.x1),y1:nm_to_view(this.y1),x2:nm_to_view(this.x2),y2:nm_to_view(this.y2),strokeWidth:nm_to_view(this.thickness+this.clearance_margin)}),this.show_number.attr({x:nm_to_view(this.x1+(this.x2-this.x1)/2),y:nm_to_view(this.y1+(this.y2-this.y1)/2),text:this.number}),this.pad_line_ref.attr({x1:nm_to_view(this.x1)}),this.pad_line_ref.attr({y1:nm_to_view(this.y1)}),this.pad_line_ref.attr({x2:nm_to_view(this.x2)}),this.pad_line_ref.attr({y2:nm_to_view(this.y2)}),this.update_anchors(),this.update_distance_marker(),void $("#object_info").html(this.get_info()))},Pad.prototype.update_editor=function(){code=sprintf('    Pad[%.2fmm %.2fmm %.2fmm %.2fmm %.2fmm %.2fmm %.2fmm "" "%d" "square"]',nm_to_mm(this.x1),nm_to_mm(this.y1),nm_to_mm(this.x2),nm_to_mm(this.y2),nm_to_mm(this.thickness),nm_to_mm(this.clearance_margin),nm_to_mm(this.thickness+this.mask_margin),this.number),editor.replaceRange(code,{line:this.line_number,ch:0},{line:this.line_number,ch:editor.getLine(this.line_number).length})},Pad.prototype.update_anchors=function(){pad_size=this.get_pad_size(),this.anchor_c.attr({cx:nm_to_view(0),cy:nm_to_view(0),r:anchor_size}),this.anchor_s.attr({cx:nm_to_view(0),cy:nm_to_view(pad_size.height/2),r:anchor_size}),this.anchor_e.attr({cx:nm_to_view(pad_size.width/2),cy:nm_to_view(0),r:anchor_size}),this.anchor_n.attr({cx:nm_to_view(0),cy:nm_to_view(-pad_size.height/2),r:anchor_size}),this.anchor_w.attr({cx:nm_to_view(-pad_size.width/2),cy:nm_to_view(0),r:anchor_size}),this.anchor_se.attr({cx:nm_to_view(pad_size.width/2),cy:nm_to_view(pad_size.height/2),r:anchor_size}),this.anchor_sw.attr({cx:nm_to_view(-pad_size.width/2),cy:nm_to_view(pad_size.height/2),r:anchor_size}),this.anchor_ne.attr({cx:nm_to_view(pad_size.width/2),cy:nm_to_view(-pad_size.height/2),r:anchor_size}),this.anchor_nw.attr({cx:nm_to_view(-pad_size.width/2),cy:nm_to_view(-pad_size.height/2),r:anchor_size}),this.anchors.transform("translate("+nm_to_view(pad_size.x+pad_size.width/2)+","+nm_to_view(pad_size.y+pad_size.height/2)+")")},Pad.prototype.update_distance_marker=function(){if(global_first_endpoint_object==this){var a=this.get_pad_size();distance_x_line.attr({x1:nm_to_view(view_to_nm(parseInt(this.endpoint_anchor.attr("cx"),10))+a.x+a.width/2),y1:nm_to_view(view_to_nm(parseInt(this.endpoint_anchor.attr("cy"),10))+a.y+a.height/2),y2:nm_to_view(view_to_nm(parseInt(this.endpoint_anchor.attr("cy"),10))+a.y+a.height/2)}),distance_y_line.attr({y1:nm_to_view(view_to_nm(parseInt(this.endpoint_anchor.attr("cy"),10))+a.y+a.height/2)});var b=Math.round(distance_x_line.attr("x2")-distance_x_line.attr("x1")),c=Math.round(distance_y_line.attr("y2")-distance_y_line.attr("y1"));distance_x_text.attr({x:+distance_x_line.attr("x1")+b/2,y:-distance_x_line.attr("y1")-10,text:b/100+"mm"}),distance_y_text.attr({x:+distance_y_line.attr("x1")+10,y:-distance_y_line.attr("y1")-c/2,text:c/100+"mm"}),$("#status_xy_distance").text("("+b/100+"mm, "+c/100+"mm)")}if(global_second_endpoint_object==this){var a=this.get_pad_size();distance_x_line.attr({x2:nm_to_view(view_to_nm(parseInt(this.endpoint_anchor.attr("cx"),10))+a.x+a.width/2)}),distance_y_line.attr({x1:nm_to_view(view_to_nm(parseInt(this.endpoint_anchor.attr("cx"),10))+a.x+a.width/2),x2:nm_to_view(view_to_nm(parseInt(this.endpoint_anchor.attr("cx"),10))+a.x+a.width/2),y2:nm_to_view(view_to_nm(parseInt(this.endpoint_anchor.attr("cy"),10))+a.y+a.height/2)});var b=Math.round(distance_x_line.attr("x2")-distance_x_line.attr("x1")),c=Math.round(distance_y_line.attr("y2")-distance_y_line.attr("y1"));distance_x_text.attr({x:+distance_x_line.attr("x1")+b/2,y:-distance_x_line.attr("y1")-10,text:b/100+"mm"}),distance_y_text.attr({x:+distance_y_line.attr("x1")+10,y:-distance_y_line.attr("y1")-c/2,text:c/100+"mm"}),$("#status_xy_distance").text("("+b/100+"mm, "+c/100+"mm)")}},Pad.prototype.get_info=function(){return pad_size=this.get_pad_size(),pad_code=sprintf("<strong>Pad</strong><br />x: %.2fmm, y: %.2fmm<br /> Pad width: %.2fmm<br />Pad height: %.2fmm<br />Mask margin: %.2fmm<br />Clearance margin: %.2fmm",nm_to_mm(pad_size.x+pad_size.width/2),nm_to_mm(pad_size.y+pad_size.height/2),nm_to_mm(pad_size.width),nm_to_mm(pad_size.height),nm_to_mm(this.mask_margin),nm_to_mm(this.clearance_margin))},Pad.prototype.move=function(a,b){this.x1=this.x1+a,this.x2=this.x2+a,this.y1=this.y1+b,this.y2=this.y2+b,this.update_editor()},Pad.prototype.select=function(){this.locked===!1&&(this.selected=!0,this.graphical_group.attr({opacity:.7}))},Pad.prototype.unselect=function(){this.selected=!1,this.graphical_group.attr({opacity:1})},Pad.prototype.lock=function(){this.locked=!0},Pad.prototype.unlock=function(){this.locked=!1},Pin.prototype.update_editor=function(){code=sprintf('    Pin[%.2fmm %.2fmm %.2fmm %.2fmm %.2fmm %.2fmm "" "%d" ""]',nm_to_mm(this.cx),nm_to_mm(this.cy),nm_to_mm(this.pad_diameter),nm_to_mm(this.clearance_margin),nm_to_mm(this.mask_margin+this.pad_diameter),nm_to_mm(this.hole_diameter),this.number),editor.replaceRange(code,{line:this.line_number,ch:0},{line:this.line_number,ch:editor.getLine(this.line_number).length})},Pin.prototype.update_anchors=function(){this.anchor_c.attr({cx:nm_to_view(this.cx),cy:nm_to_view(this.cy),r:anchor_size}),this.anchor_h.attr({cx:nm_to_view(this.cx+this.hole_diameter/2),cy:nm_to_view(this.cy),r:anchor_size}),this.anchor_p.attr({cx:nm_to_view(this.cx+this.pad_diameter/2),cy:nm_to_view(this.cy),r:anchor_size})},Pin.prototype.draw=function(){this.mask.attr({cx:nm_to_view(this.cx),cy:nm_to_view(this.cy),r:nm_to_view((this.mask_margin+this.pad_diameter)/2)}),this.clearance.attr({cx:nm_to_view(this.cx),cy:nm_to_view(this.cy),r:nm_to_view((this.clearance_margin+this.pad_diameter)/2)}),this.pad.attr({cx:nm_to_view(this.cx),cy:nm_to_view(this.cy),r:nm_to_view(this.pad_diameter/2)}),this.hole.attr({cx:nm_to_view(this.cx),cy:nm_to_view(this.cy),r:nm_to_view(this.hole_diameter/2)}),this.show_number.attr({x:nm_to_view(this.cx),y:nm_to_view(this.cy),text:this.number}),$("#object_info").html(this.get_info()),this.update_anchors()},Pin.prototype.get_info=function(){return pad_code=sprintf("<strong>Pin</strong><br />x: %.2fmm, y: %.2fmm<br />Pad diameter: %.2fmm<br />Hole diameter: %.2fmm<br />Mask margin: %.2fmm<br />Clearance: %.2fmm",nm_to_mm(this.cx),nm_to_mm(this.cy),nm_to_mm(this.pad_diameter),nm_to_mm(this.hole_diameter),nm_to_mm(this.mask_margin),nm_to_mm(this.clearance_margin))},Pin.prototype.move=function(a,b){this.cx=this.cx+a,this.cy=this.cy+b,this.update_editor()},Pin.prototype.select=function(){this.locked===!1&&(this.selected=!0,this.graphical_group.attr({opacity:.7}))},Pin.prototype.unselect=function(){this.selected=!1,this.graphical_group.attr({opacity:1})},Pin.prototype.lock=function(){this.locked=!0},Pin.prototype.unlock=function(){this.locked=!1},paper.node.addEventListener("contextmenu",function(a){console.log("You've tried to open context menu"),a.preventDefault()},!1);var editor=CodeMirror.fromTextArea(document.getElementById("footprint_code"),{lineNumbers:!1,undoDepth:1e4,mode:"text/html",vimMode:!0});editor.on("change",function(a,b){if(b.text.length>b.removed.length)for(var c=b.from.line;c<b.from.line+b.text.length;c++){var d=b.text[c-b.from.line];""!=d&&0==add_object(d,c)}else if(b.text.length<b.removed.length)for(var e=b.from.line,c=b.from.line;c<b.from.line+b.removed.length;c++){var d=b.removed[c-b.from.line];""!=d&&0==remove_object(e)&&e--,e++}else for(var c=b.from.line;c<b.from.line+b.text.length;c++){var d=editor.getLine(c);""!=d&&0==edit_object(d,c)}});var hl_line=editor.addLineClass(0,"background","selected_pad");editor.removeLineClass(0,"background","selected_pad"),editor.on("cursorActivity",function(){editor.getLine(editor.getCursor().line).match(/Pad/)&&(editor.removeLineClass(hl_line,"background","selected_pad"),hl_line.text.match(/Pad/)&&objects[editor.getLineNumber(hl_line)].pad.attr({stroke:"#8c96a0"}),hl_line=editor.addLineClass(editor.getCursor().line,"background","selected_pad"),objects[editor.getCursor().line].pad.attr({stroke:"#acb6c0"}))}),editor.on("blur",function(){editor.removeLineClass(hl_line,"background","selected_pad"),hl_line.text.match(/Pad/)&&objects[editor.getLineNumber(hl_line)].pad.attr({stroke:"#8c96a0"})}),$("#vim_mode_cb").click(function(){editor.setOption("vimMode",this.checked)});var begin_drag_workspace=function(a,b,c){1!=global_dragging&&(2==c.button?(this.origin_x=origin_x,this.origin_y=origin_y):0==c.button&&(this.original_posx=a-$("#svg").offset().left,this.original_posy=b-$("#svg").offset().top,selection_box.attr({x:this.original_posx,y:this.original_posy,width:0,height:0,visibility:"visible"})))},drag_workspace=function(a,b,c,d,e){if(1!=global_dragging)if(2==e.button)origin_x=this.origin_x+a,origin_y=this.origin_y+b,zoom_group.transform("translate("+origin_x+","+origin_y+") scale("+zoom_level+","+zoom_level+")");else if(0==e.button){var f=0,g=0;0>a&&(f=a,a=-1*a),0>b&&(g=b,b=-1*b),selection_box.transform("translate("+f+","+g+")"),selection_box.attr({x:this.original_posx,y:this.original_posy,width:a,height:b})}},end_drag_workspace=function(a){if(1!=global_dragging&&0==a.button){selection_box.attr({visibility:"hidden"});var b=selection_box.getBBox();(b.width>0||b.height>0)&&deselect_all_objects();for(var c=0;c<objects.length;c++){var d=objects[c];if(void 0!=d.graphical_group){var e=d.graphical_group.getBBox();e.x>=(b.x-origin_x)/zoom_level&&e.x<=(b.x2-origin_x)/zoom_level&&e.x2>=(b.x-origin_x)/zoom_level&&e.x2<=(b.x2-origin_x)/zoom_level&&e.y>=(b.y-origin_y)/zoom_level&&e.y<=(b.y2-origin_y)/zoom_level&&e.y2>=(b.y-origin_y)/zoom_level&&e.y2<=(b.y2-origin_y)/zoom_level&&d.select()}}}},deselect_all_objects=function(){objects.forEach(function(a){"object"==typeof a&&a.unselect()})};paper.node.addEventListener("mousewheel",mouse_wheel_handler,!1),paper.drag(drag_workspace,begin_drag_workspace,end_drag_workspace);var zoom_level=1,zoom_group=paper.group(grid_small,grid_big,center,distance_x,distance_y,copperplane,solderstop);zoom_group.transform("translate("+origin_x+","+origin_y+") scale("+zoom_level+","+zoom_level+")");
//# sourceMappingURL=pcb-footprint-editor.min.js.map